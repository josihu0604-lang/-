class VerificationEngine{constructor(c={}){this.amountThreshold=c.amountThreshold??0.03;this.dayThreshold=c.dayThreshold??3;}verify(d,a){const i=[];const m={amountDiff:0,dayDiff:0,subjectMatch:!!d.subjectMatched};if(typeof d.amount==='number'&&typeof a.balance==='number'){const D=Math.abs(d.amount-a.balance);const p=d.amount>0?D/d.amount:0;m.amountDiff=+p.toFixed(4);if(p>this.amountThreshold){i.push({type:'AMOUNT_MISMATCH',severity:p>0.05?'CRIT':'WARN',message:`금액 불일치: ${(p*100).toFixed(2)}% (허용: 3%)`});}}if(d.date&&a.date){const d1=new Date(d.date);const d2=new Date(a.date);const dd=Math.round((d2-d1)/86400000);m.dayDiff=Math.abs(dd);if(Math.abs(dd)>this.dayThreshold){i.push({type:'DATE_MISMATCH',severity:Math.abs(dd)>7?'CRIT':'WARN',message:`날짜 불일치: ${Math.abs(dd)}일 (허용: 3영업일)`});}}if(!d.subjectMatched){i.push({type:'SUBJECT_MISMATCH',severity:'CRIT',message:'문서 주체 불일치'});}const S=['대포','차명','위조','가공','조작'];const all=[...(d.memos||[]),...(a.memos||[])];const hits=all.filter(x=>S.some(k=>x.includes(k)));if(hits.length){i.push({type:'SUSPICIOUS_MEMO',severity:'WARN',message:'의심스러운 메모 발견'});}const sc={INFO:0,WARN:0,CRIT:0};for(const e of i){sc[e.severity]++;}return{issues:i,metrics:m,severity_counts:sc};}}module.exports={VerificationEngine};
